# Step 19 – 투표 이미지 업로드 기능 계획

## 목표 & 성공 기준
- 투표 생성/편집 시 옵션별 이미지 업로드를 지원하고, `/poll/[id]`에서 안정적으로 렌더링된다.
- 허용 확장자/크기/권한 가드를 통과한 파일만 저장되며, 실패·취소 시 누수된 객체가 없거나 정리 루틴이 작동한다.
- 모바일/저속 네트워크에서도 미리보기·업로드 진행 상태가 명확히 안내된다.

## 범위
- 단일 옵션당 1개 이미지(다중 업로드는 후속 범위).
- 확장자: JPEG/PNG/WebP, 기본 제한 5~10MB(확정 필요).
- 업로드 경로: `polls/{pollId}/{optionId}.{ext}` (생성 전 임시 UUID는 후술).

## 설계 안 (백엔드)
- 스토리지: `poll_images` 버킷 생성, 정책
  - 읽기: 공개 이미지면 public, 비공개면 서명 URL 반환 방식 선택 필요.
  - 쓰기/삭제: 생성자(또는 서비스 롤)만 허용. 경로 prefix로 RLS 대체.
- DB 변경
  - `poll_options.image_url TEXT` (nullable), `image_width/height` 선택적 메타.
  - 인덱스는 필요 없음(조회 키는 poll_id).
- RPC/함수
  - `create_new_poll` 확장: 옵션 배열에 `image_url` 메타 허용.
  - 옵션 업데이트 RPC 존재 시 이미지 교체/삭제 처리 추가.
  - 업로드 토큰 발급용 서명 URL 함수(Edge Function 또는 App Route) 추가: `POST /api/polls/image-upload-url` (pollId/optionId/filename 전달).
- 정리 루틴
  - 폼 제출 실패 시 업로드된 객체 삭제하는 best-effort API(`DELETE /api/polls/image-upload-url?path=...`) 또는 서버 클린업 작업.

## 설계 안 (프론트)
- 생성/편집 폼
  - 파일 선택/드래그앤드롭, 미리보기(로컬 blob), 업로드 진행률, 취소/재시도.
  - 클라이언트 검증: 확장자/크기/옵션당 1개, 업로드 전 압축/리사이즈는 추후 결정.
  - 제출 흐름: (1) 서명 URL 요청 → (2) 업로드 → (3) 반환된 public/서명 경로를 폼 상태에 저장 → (4) 투표 생성/업데이트 호출.
  - 업로드 실패/취소 시 폼 상태와 미리보기 초기화.
- 상세 렌더
  - `next/image` + `sizes` 지정, skeleton/placeholder 처리, alt 텍스트는 옵션 텍스트 기반.

## 안전/보안/비용
- 입력 검증: MIME/확장자/크기 제한, 경로 강제(pollId/optionId).
- 공개/비공개 정책 결정: 공개 이미지는 CDN 캐시 활용, 비공개는 서명 URL + 만료(예: 5분).
- 누수 방지: 제출 실패 시 업로드된 경로 리스트를 best-effort 삭제, 배치 스크립트로 고아 객체 정리 검토.
- 비용/성능: 썸네일/리사이즈 필요 시 Edge Function 고려, 큰 원본은 제한.

## QA/테스트 시나리오
- 단위: 확장자/크기 검증, 미리보기 렌더, 진행률/취소/재시도 상태 전환.
- 통합: 서명 URL 발급 실패, 업로드 4xx/5xx, 제출 성공 시 image_url 반영, 제출 실패 시 클린업 호출.
- E2E: 모바일 뷰에서 이미지 업로드→투표 생성→상세에서 렌더 확인, 이미지 교체/삭제 플로우.

## 오픈 이슈/결정 필요
- 이미지 공개 범위: 완전 공개 vs 서명 URL(만료) 정책.
- 최대 크기/해상도/압축 여부.
- 고아 객체 정리 주기/방식(GitHub Actions? on-demand?).
