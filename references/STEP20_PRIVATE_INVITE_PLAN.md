# Step 20 – 비공개 투표 언리스트드 링크 + 정원 제한(max_voters)

## 목표 & 성공 기준
- 비공개 투표(`is_public = false`)는 **목록/검색에 노출되지 않지만**, 로그인 사용자가 링크로 접근하면 조회·투표할 수 있다.
- 채팅방 등에서 링크 공유로 빠르게 참여자를 모으고, 빠르게 결과를 확인하는 흐름을 지원한다.
- 비공개 투표에서 선택적으로 `max_voters`를 설정할 수 있고, 서버가 **고유 투표자 수 기준 선착순 N명**을 원자적으로 보장한다.
- `max_voters`에 도달하면 투표는 자동으로 `status='closed'`로 마감되고, 이후 참여자는 결과만 확인한다.

## 범위 (Step 20 최소 범위)
- 비공개 투표 언리스트드 링크 접근(로그인 필요)
- 선착순 참여 제한(`max_voters`) + 정원 도달 시 자동 마감
- UI: 비공개 선택 시 정원 입력, 상세에서 현재/최대 표시 및 마감 상태 안내

## 후속 범위(보류/Step 22)
- 초대 화이트리스트(`poll_invites` 테이블)
- 이메일 초대/초대 토큰
- 수동/예약 마감, 정원 증설/재오픈 등 운영 기능

## 기능 정의
### 1) 비공개 투표(언리스트드 링크)
- 비공개 투표는 `/polls`, `/favorites` 등 목록 API에서 숨긴다.
- 링크(`/poll/[id]`)로 접근한 **로그인 사용자**에게 조회/투표 권한을 부여한다.
- 비로그인 사용자는 조회·투표할 수 없다.

### 2) 선착순 참여 제한(`max_voters`)
- 비공개 투표 생성 시 선택적으로 `max_voters`를 설정할 수 있다.
- 서버는 `COUNT(DISTINCT user_votes.user_id)`를 기준으로 상한을 강제한다.
- N번째 투표 성공 직후 `status='closed'`로 자동 마감된다.
- 제한 미설정(NULL) 시 기존처럼 계속 진행된다.

## 설계 안 (백엔드)
### DB 스키마
- `polls` 컬럼 추가
  - `max_voters INT NULL` : 비공개에서만 사용, NULL이면 제한 없음

### RLS/권한
- `polls` RLS는 기존 유지:
  - 공개 투표는 누구나 SELECT 가능
  - 비공개 투표는 생성자만 SELECT 가능
- 대신 상세 조회/접근 체크/투표 RPC를 `SECURITY DEFINER`로 교체해 언리스트드 링크 모델을 구현한다.

### RPC
- `create_new_poll(..., max_voters_param)` : 비공개 정원 제한 저장(공개 투표는 NULL 강제)
- `can_access_poll(p_poll_id)` :
  - 공개 투표는 true
  - 비공개 투표는 로그인 사용자면 true, 비로그인 사용자는 false
- `get_poll_with_user_status(p_id)` :
  - 공개 투표 또는 (비공개 + 로그인 사용자)만 반환
  - 응답에 `max_voters` 포함
- `increment_vote(option_id_to_update, poll_id_for_vote)` :
  - `polls` 행을 `FOR UPDATE`로 잠금
  - 비공개 + `max_voters` 설정 시 정원 체크 후 투표 진행/거절
  - N번째 투표 성공 직후 `status='closed'`로 자동 마감

## 클라이언트 UI/UX
- `/create-poll`
  - 비공개 선택 시 `maxVoters` 입력(선택) 노출
  - 정원 도달 시 자동 마감 안내
- `/poll/[id]`
  - 비공개 투표는 로그인 사용자만 접근 가능
  - `max_voters`가 있으면 “현재 X / 최대 N명” 표시
  - 마감 시 “결과만 확인 가능” 상태/버튼 비활성

## QA/테스트 시나리오
- 비공개 링크 접근
  - 로그인 사용자: 링크로 조회·투표 가능
  - 비로그인 사용자: 조회·투표 불가
- 정원 제한
  - N번째 투표 성공 후 자동 마감
  - N+1번째 투표는 서버에서 거절
- 공개 투표 영향 없음
